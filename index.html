<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>3D Игра — Сбор кубов (iOS)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            overflow: hidden; 
            background: #000; 
            touch-action: manipulation;
            cursor: pointer !important; /* КРИТИЧЕСКИ ВАЖНО для Safari iOS */
            font-family: Arial, sans-serif; 
        }
        canvas { display: block; width: 100vw; height: 100vh; }
        #score {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 28px;
            z-index: 100;
            background: rgba(0,0,0,0.7);
            padding: 15px 30px;
            border-radius: 15px;
        }
        .joystick {
            position: fixed;
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: rgba(255,255,255,0.15);
            border: 4px solid rgba(255,255,255,0.3);
            pointer-events: auto;
            z-index: 50;
        }
        #moveJoy { bottom: 30px; left: 30px; }
        #lookJoy { bottom: 30px; right: 30px; }
        .knob {
            position: absolute;
            width: 60px;
            height: 60px;
            background: rgba(255,255,255,0.5);
            border-radius: 50%;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        }
        #jumpBtn {
            position: fixed;
            bottom: 200px;
            right: 40px;
            width: 90px;
            height: 90px;
            background: linear-gradient(145deg, #4facfe, #00f2fe);
            border: 4px solid white;
            border-radius: 50%;
            color: white;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            pointer-events: auto;
        }
        #startScreen {
            position: fixed;
            inset: 0;
            background: #87ceeb;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
            color: white;
        }
        #startScreen button {
            margin-top: 50px;
            padding: 20px 50px;
            font-size: 28px;
            background: #00f2fe;
            border: none;
            border-radius: 20px;
            color: white;
        }
        #errorScreen {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 300;
            color: white;
            font-size: 22px;
            text-align: center;
            padding: 20px;
        }
        #errorScreen button {
            margin-top: 30px;
            padding: 15px 30px;
            font-size: 20px;
            background: #ff4444;
            border: none;
            border-radius: 15px;
        }
    </style>
</head>
<body>
    <div id="startScreen">
        <h1>3D Игра: Сбор кубов</h1>
        <p>Нажмите кнопку, чтобы начать</p>
        <button id="startBtn">СТАРТ</button>
    </div>

    <div id="errorScreen">
        <h2>Ошибка WebGL</h2>
        <p>Не удалось запустить 3D. Перезагрузите страницу или попробуйте позже.</p>
        <button onclick="location.reload()">Перезагрузить</button>
    </div>

    <div id="score">Счёт: 0</div>

    <div id="moveJoy" class="joystick"><div id="moveKnob" class="knob"></div></div>
    <div id="lookJoy" class="joystick"><div id="lookKnob" class="knob"></div></div>
    <div id="jumpBtn">↑ ПРЫЖОК</div>

    <script src="https://cdn.jsdelivr.net/npm/three@0.169.0/build/three.min.js"></script>
    <script>
        let camera, scene, renderer, canvas;
        let moveVector = new THREE.Vector2(0,0);
        let lookVector = new THREE.Vector2(0,0);
        let velocity = new THREE.Vector3(0,0,0);
        let canJump = true;
        let score = 0;
        const collectibles = [];

        const startScreen = document.getElementById('startScreen');
        const errorScreen = document.getElementById('errorScreen');

        document.getElementById('startBtn').addEventListener('touchstart', startGame, { passive: false });
        document.getElementById('startBtn').addEventListener('click', startGame);

        function startGame(e) {
            if (e) e.preventDefault();
            startScreen.style.display = 'none';

            // Создаём renderer только после касания
            renderer = new THREE.WebGLRenderer({
                antialias: false,     // Отключаем для стабильности на iOS
                alpha: false,         // Важно для избежания чёрного экрана
                powerPreference: "high-performance"
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.body.appendChild(renderer.domElement);
            canvas = renderer.domElement;

            // Проверка поддержки WebGL
            if (!renderer.getContext()) {
                errorScreen.style.display = 'flex';
                return;
            }

            // Обработка context lost (частая проблема на iOS)
            canvas.addEventListener('webglcontextlost', (e) => {
                e.preventDefault();
                errorScreen.style.display = 'flex';
            });

            // Инициализация сцены
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.y = 10;

            const ambient = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambient);
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(50, 100, 50);
            scene.add(dirLight);

            const floor = new THREE.Mesh(
                new THREE.PlaneGeometry(200, 200),
                new THREE.MeshStandardMaterial({ color: 0x228b22 })
            );
            floor.rotation.x = -Math.PI / 2;
            scene.add(floor);

            for (let i = 0; i < 15; i++) {
                const cube = new THREE.Mesh(
                    new THREE.BoxGeometry(3, 3, 3),
                    new THREE.MeshStandardMaterial({ color: 0xffff00 })
                );
                cube.position.x = Math.random() * 180 - 90;
                cube.position.z = Math.random() * 180 - 90;
                cube.position.y = 1.5;
                scene.add(cube);
                collectibles.push(cube);
            }

            setupControls();
            window.addEventListener('resize', onResize);
            animate();
        }

        function setupControls() {
            // Джойстик движения
            const moveJoy = document.getElementById('moveJoy');
            const moveKnob = document.getElementById('moveKnob');
            let moveActive = false;

            moveJoy.addEventListener('touchstart', (e) => { e.preventDefault(); moveActive = true; handleMove(e.touches[0]); });
            moveJoy.addEventListener('touchmove', (e) => { e.preventDefault(); if (moveActive) handleMove(e.touches[0]); });
            moveJoy.addEventListener('touchend', () => { moveActive = false; resetKnob(moveKnob, moveVector); });

            function handleMove(touch) {
                const rect = moveJoy.getBoundingClientRect();
                const dx = (touch.clientX - rect.left - 70);
                const dy = (touch.clientY - rect.top - 70);
                const dist = Math.min(Math.hypot(dx, dy), 50);
                const angle = Math.atan2(dy, dx);
                moveKnob.style.transform = `translate(-50%, -50%) translate(${dist * Math.cos(angle)}px, ${dist * Math.sin(angle)}px)`;
                moveVector.set(dx / 50, dy / 50);
            }

            // Джойстик взгляда (аналогично)
            const lookJoy = document.getElementById('lookJoy');
            const lookKnob = document.getElementById('lookKnob');
            let lookActive = false;

            lookJoy.addEventListener('touchstart', (e) => { e.preventDefault(); lookActive = true; handleLook(e.touches[0]); });
            lookJoy.addEventListener('touchmove', (e) => { e.preventDefault(); if (lookActive) handleLook(e.touches[0]); });
            lookJoy.addEventListener('touchend', () => { lookActive = false; resetKnob(lookKnob, lookVector); });

            function handleLook(touch) {
                const rect = lookJoy.getBoundingClientRect();
                const dx = (touch.clientX - rect.left - 70);
                const dy = (touch.clientY - rect.top - 70);
                const dist = Math.min(Math.hypot(dx, dy), 50);
                const angle = Math.atan2(dy, dx);
                lookKnob.style.transform = `translate(-50%, -50%) translate(${dist * Math.cos(angle)}px, ${dist * Math.sin(angle)}px)`;
                lookVector.set(dx / 50 * 2, dy / 50 * 2);
            }

            // Прыжок
            document.getElementById('jumpBtn').addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (canJump) { velocity.y = 18; canJump = false; }
            });
        }

        function resetKnob(knob, vec) {
            knob.style.transform = 'translate(-50%, -50%)';
            vec.set(0,0);
        }

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);

            velocity.x *= 0.9;
            velocity.z *= 0.9;
            velocity.y -= 0.5; // гравитация

            const forward = new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion);
            const right = new THREE.Vector3(1,0,0).applyQuaternion(camera.quaternion);

            velocity.add(forward.multiplyScalar(moveVector.y * 0.8));
            velocity.add(right.multiplyScalar(moveVector.x * 0.8));

            camera.position.add(velocity);

            if (camera.position.y < 10) {
                camera.position.y = 10;
                velocity.y = 0;
                canJump = true;
            }

            camera.rotation.y -= lookVector.x * 0.01;
            camera.rotation.x -= lookVector.y * 0.01;
            camera.rotation.x = Math.max(-Math.PI/2 + 0.1, Math.min(Math.PI/2 - 0.1, camera.rotation.x));

            // Сбор кубов
            collectibles.forEach(c => {
                if (c.visible && camera.position.distanceTo(c.position) < 5) {
                    c.visible = false;
                    score++;
                    document.getElementById('score').textContent = 'Счёт: ' + score;
                }
            });

            renderer.render(scene, camera);
        }
    </script>
</body>
</html>