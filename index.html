<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>3D Игра — Сбор кубов (iOS фикс)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            overflow: hidden; 
            background: #000; 
            touch-action: manipulation; /* Лучше для touch */
            cursor: pointer; /* Фикс для touch events в Safari */
            font-family: Arial, sans-serif; 
        }
        canvas { display: block; width: 100%; height: 100%; }
        #score {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 28px;
            z-index: 100;
            background: rgba(0,0,0,0.7);
            padding: 15px 25px;
            border-radius: 15px;
        }
        #ui {
            position: fixed;
            bottom: 20px;
            left: 0;
            right: 0;
            height: 160px;
            pointer-events: none;
            z-index: 50;
        }
        .joystick {
            position: absolute;
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border: 4px solid rgba(255,255,255,0.3);
            pointer-events: auto;
        }
        #moveJoy { bottom: 30px; left: 30px; }
        #lookJoy { bottom: 30px; right: 30px; }
        .knob {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255,255,255,0.4);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        #jumpBtn {
            position: absolute;
            bottom: 200px;
            right: 40px;
            width: 90px;
            height: 90px;
            border-radius: 50%;
            background: linear-gradient(145deg, #4facfe, #00f2fe);
            border: 4px solid rgba(255,255,255,0.8);
            color: white;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 20px rgba(0,150,255,0.4);
            pointer-events: auto;
            user-select: none;
        }
        #startScreen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #87ceeb;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
            color: white;
            font-size: 24px;
            text-align: center;
        }
        #startScreen button {
            margin-top: 40px;
            padding: 20px 40px;
            font-size: 24px;
            background: #00f2fe;
            border: none;
            border-radius: 20px;
            color: white;
        }
        #error {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 300;
            color: white;
            font-size: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="startScreen">
        <h1>3D Игра: Сбор кубов</h1>
        <p>Коснитесь кнопки, чтобы начать</p>
        <button id="startBtn">СТАРТ</button>
    </div>

    <div id="error">
        <h2>Ошибка WebGL</h2>
        <p>Контекст потерян. Перезагрузите страницу.</p>
    </div>

    <div id="score">Счёт: 0</div>
    <div id="ui">
        <div id="moveJoy" class="joystick"><div class="knob" id="moveKnob"></div></div>
        <div id="lookJoy" class="joystick"><div class="knob" id="lookKnob"></div></div>
        <div id="jumpBtn">↑</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/three@0.169.0/build/three.min.js"></script>
    <script>
        let camera, scene, renderer;
        let moveVector = new THREE.Vector2(0, 0);
        let lookVector = new THREE.Vector2(0, 0);
        let velocity = new THREE.Vector3();
        let canJump = false;
        let score = 0;
        const collectibles = [];
        let started = false;

        const startScreen = document.getElementById('startScreen');
        const errorDiv = document.getElementById('error');

        document.getElementById('startBtn').addEventListener('touchstart', startGame);
        document.getElementById('startBtn').addEventListener('click', startGame); // на случай десктопа

        function startGame(e) {
            e.preventDefault();
            if (started) return;
            started = true;
            startScreen.style.display = 'none';
            init();
            animate();
        }

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 10, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.body.appendChild(renderer.domElement);

            // Обработка context lost
            renderer.domElement.addEventListener('webglcontextlost', (e) => {
                e.preventDefault();
                errorDiv.style.display = 'flex';
            });

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(50, 100, 50);
            scene.add(directionalLight);

            const floorGeometry = new THREE.PlaneGeometry(200, 200);
            const floorMaterial = new THREE.MeshStandardMaterial({ color: 0x228b22 });
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = -Math.PI / 2;
            scene.add(floor);

            for (let i = 0; i < 15; i++) {
                const cube = new THREE.Mesh(
                    new THREE.BoxGeometry(3, 3, 3),
                    new THREE.MeshStandardMaterial({ color: 0xffff00 })
                );
                cube.position.x = (Math.random() - 0.5) * 180;
                cube.position.z = (Math.random() - 0.5) * 180;
                cube.position.y = 1.5;
                scene.add(cube);
                collectibles.push(cube);
            }

            setupControls();

            window.addEventListener('resize', onWindowResize);
        }

        // Тот же код джойстиков и прыжка, что и раньше (оставляю без изменений для краткости)
        function setupControls() {
            // ... (тот же код из предыдущей версии для moveJoy, lookJoy, jumpBtn)
            const moveJoy = document.getElementById('moveJoy');
            const moveKnob = document.getElementById('moveKnob');
            let moveTouchId = null;

            function updateMoveKnob(dx, dy) {
                const maxDist = 40;
                const dist = Math.hypot(dx, dy);
                const limited = dist > maxDist ? maxDist / dist : 1;
                moveKnob.style.transform = `translate(-50%, -50%) translate(${dx * limited}px, ${dy * limited}px)`;
                moveVector.set(dx / maxDist, dy / maxDist);
            }

            moveJoy.addEventListener('touchstart', handleTouch);
            moveJoy.addEventListener('touchmove', handleTouch);
            moveJoy.addEventListener('touchend', () => { moveTouchId = null; updateMoveKnob(0,0); });

            function handleTouch(e) {
                e.preventDefault();
                for (let touch of e.touches) {
                    if (moveTouchId === null || touch.identifier === moveTouchId) {
                        moveTouchId = touch.identifier;
                        const rect = moveJoy.getBoundingClientRect();
                        const dx = (touch.clientX - rect.left - rect.width/2);
                        const dy = (touch.clientY - rect.top - rect.height/2);
                        updateMoveKnob(dx, dy);
                        break;
                    }
                }
            }

            // Аналогично для lookJoy (смотри предыдущий код)
            // ... (вставь код для lookJoy и jumpBtn из прошлой версии)

            // Прыжок
            document.getElementById('jumpBtn').addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (canJump) { velocity.y = 20; canJump = false; }
            });
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);

            const delta = 0.016;

            velocity.x *= 0.85;
            velocity.z *= 0.85;
            velocity.y -= 30 * delta;

            const forward = new THREE.Vector3(0, 0, -1).applyQuaternion(camera.quaternion);
            const right = new THREE.Vector3(1, 0, 0).applyQuaternion(camera.quaternion);

            const moveSpeed = 200 * delta;
            velocity.add(forward.multiplyScalar(-moveVector.y * moveSpeed));
            velocity.add(right.multiplyScalar(moveVector.x * moveSpeed));

            camera.position.add(velocity.clone().multiplyScalar(delta));

            if (camera.position.y < 10) {
                camera.position.y = 10;
                velocity.y = 0;
                canJump = true;
            }

            camera.rotation.y -= lookVector.x * 0.05;
            camera.rotation.x -= lookVector.y * 0.05;
            camera.rotation.x = Math.clamp(camera.rotation.x, -Math.PI/2, Math.PI/2);

            collectibles.forEach(cube => {
                if (cube.visible && camera.position.distanceTo(cube.position) < 5) {
                    cube.visible = false;
                    score++;
                    document.getElementById('score').textContent = `Счёт: ${score}`;
                }
            });

            renderer.render(scene, camera);
        }
    </script>
</body>
</html>